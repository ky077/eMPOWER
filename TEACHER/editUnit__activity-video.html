<!doctype html>
<html lang="zh-tw">
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="eMPOWER華語文字詞句教學平台">
<meta name="author" content="eMPOWER華語文字詞句教學平台">
<title>eMPOWER華語文字詞句教學平台</title>
<link rel="shortcut icon" type="image/x-icon" href="../Content/images/eMPOWER.ico">
<link rel="stylesheet" type="text/css" href="../Content/css/bootstrap-lg.min.css">
<link rel="stylesheet" type="text/css" href="../Content/css/ie10-viewport-bug-workaround.css">
<link rel="stylesheet" type="text/css" href="../Content/widgets/fontawesome-free-5.15.3-web/css/all.css">

<!-- this page widgets CSS -->
<link rel="stylesheet" type="text/css" href="../Content/widgets/bootstrap-fileinput-master/css/fileinput.css">
<!-- my core CSS -->
<link rel="stylesheet" type="text/css" href="../Content/css/eMPOWERstyles.css">
</head>

<body>
<header>
  <nav class="navbar navi-main navbar-fixed-top">
    <div class="container-fluid">
      <div class="row">
        <div class="col-xs-12">
          <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar"> <span class="sr-only">展開上方主選單</span> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span> </button>
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#sidebar" aria-expanded="false" aria-controls="sidebar"> <span class="sr-only">展開左側選單</span> <i class="fas fa-chevron-right"></i><i class="fas fa-chevron-left"></i></button>
            <a class="navbar-brand" href="#"> <img src="../Content/images/eMPOWER-img.svg" alt="eMPOWER華語文字詞句教學平台" class="img-responsive"> </a>
            <h1>eMPOWER華語文字詞句教學平台</h1>
          </div>
          <div id="navbar" class="navbar-collapse collapse">
            <ul class="nav navbar-nav">
              <li class="navTab-Tindex"><a href="Tindex.html">首頁</a></li>
              <li class="navTab-chineseSeries"><a href="chineseSeries.html">華語教材系列</a></li>
              <li class="navTab-customized"><a href="customized.html">建立自編教材</a></li>
              <li class="navTab-myLibs"><a href="myLibs.html">我的教材庫</a></li>
              <li class="navTab-classMgt dropdown"> <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">班級管理&nbsp;<span class="caret"></span></a>
                <ul class="dropdown-menu">
                  <li><a href="classMgt__students.html">學生名單</a></li>
                  <li><a href="classMgt__groups.html">指派教材</a></li>
                  <li><a href="classMgt__learning.html">學習紀錄</a></li>
                  <li><a href="classMgt__score.html">評量結果</a></li>
                </ul>
              </li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
              <li class="dropdown"><a class="navi-main__loginedBtn" data-target="#" href="#" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">你好，張花花！</a>
                <ul class="dropdown-menu navi-main__userMenu">
                  <li><a href="../index.html" class="btn navi-main__logoutBtn">登出</a></li>
                </ul>
              </li>
              <li class="dropdown"><a class="navi-main__languageBtn" data-target="#" href="#" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">中文(正體)&nbsp;<span class="caret"></span></a>
                <ul class="dropdown-menu navi-main__languageMenu">
                  <li><a href="" check="checked"><span class="language-icon"><span class="glyphicon glyphicon-ok" aria-hidden="true"></span></span>&nbsp;中文(正體)</a></li>
                  <li><a href=""><span class="language-icon"><span class="glyphicon glyphicon-ok" aria-hidden="true"></span></span>&nbsp;中文(简体)</a></li>
                  <li><a href=""><span class="language-icon"><span class="glyphicon glyphicon-ok" aria-hidden="true"></span></span>&nbsp;English(United States)</a></li>
                </ul>
              </li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </nav>
</header>
<!-- ------- ------- ------- ------- ------- ------- ------- -->
<main>
  <div class="container-fluid">
    <div class="row"> 
      <!-- 左邊選單start -->
      <div class="col-sm-3 col-md-2 sidebar navbar-collapse collapse" id="sidebar">
        <div class="editUnit-item">
          <h3 class="textbookName">中文真有趣</h3>
          <div class="unitFront">
            <div class="embed-responsive embed-responsive-16by9"> <img src="../Content/images/default-unit.png" class="embed-responsive-item" alt="單元封面"> </div>
          </div>
          <h4 class="unitName">第一課 問好</h4>
        </div>
      </div>
      <!-- 左邊選單end --> 
      <!-- 右邊內容start -->
      <div class="col-sm-12 col-md-10 col-md-offset-2 sidebar-main">
        <div class="sidebar-main-block"> 
          <!-- 標題 -->
          <h2 class="text-cyan editUnit-title"> <span class="bg-cyan editUnit-icon"><img src="../Content/images/libs/classActivity.svg" alt="課堂活動圖示"/></span>課堂活動</h2>
          <!-- 內容 -->
          <div class="editUnit-content editCourse-content__classActivity">
            <h3 class="editUnit-subtitle"><img src="../Content/images/classActivity/video-icon.png" height="40" alt="videoIcon" class="mr-1"/>看影片回答問題</h3>
            <div class="editCourse-CWSblock">
              <div class="editCourse-tab-content">
                <div class="tab-content">
                  <div class="tab-pane active">
                    <div class="form-horizontal form-style-2 pt-5">
                      <div class="form-group"> <label class="col-md-3 col-lg-2 pr-0 control-label"><span class="text-red">*</span>影片網址</label>
                        <div class="col-md-9 col-lg-9 col-xl-8">
                          <div class="input-group">
                            <input type="text" class="form-control" placeholder="請輸入youtube 網址" id="inputVideo">
                            <span class="input-group-btn">
                            <button class="btn btn-main-cyan" type="button" id="btnPreview">預覽</button>
                            </span> </div>
                        </div>
                      </div>
                      <div class="form-group"> <label class="col-md-3 col-lg-2 pr-0 control-label">編輯影片</label>
                        <div class="col-md-9 col-lg-9 col-xl-8">
                          <div class="embed-responsive embed-responsive-16by9 CAvideo-Default"> <img src="" class="embed-responsive-item" id="ytDefault" style="display: none"/>
                            <div class="embed-responsive-item" id="ytplayer"></div>
                          </div>
                          <div class="CAvideo-clip" style="display: none">
                            <div class="clip-slider"> </div>
                            <div class="clip-tools">
                              <button class="btn btn-main-cyan-white" id="CLIP_CANCEL">取消</button>
                              <button class="btn btn-main-cyan" id="CLIP_OK">剪片</button>
                            </div>
                          </div>
                          <div class="CAvideo-player" style="display: none">
                            <div class="em-player">
                              <div class="em-player__control">
                                <button type="button" class="btn btn-main-cyan-white em-play"> <span class="glyphicon glyphicon-play"></span></button>
                                <button type="button" class="btn btn-main-cyan-white em-pause" style="display: none"> <span class="glyphicon glyphicon-pause"></span></button>
                                <button type="button" class="btn btn-main-cyan-white em-replay" style="display: none"> <span class="glyphicon glyphicon-repeat"></span></button>
                              </div>
                              <div class="em-player__Nowsec">00:00</div>
                              <div class="em-player__progress">
                                <div class="progress"> </div>
                              </div>
                              <div class="em-player__totalSec">00:00</div>
                              <div class="em-player__tools">
                                <button class="btn btn-main-cyan-white" id="CLIP">剪片</button>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                      <div class="form-group"> <label class="hidden-xs hidden-sm col-md-3 col-lg-2 pr-0 control-label"></label>
                        <div class="col-md-9 col-lg-9 col-xl-8">
                          <button type="button" class="btn btn-main-cyan btn-block" id="INSERT" disabled="disabled">
                          <i class="fas fa-plus"></i>&nbsp;新增題目<span class="ml-1">(<label>00:00</label>)</span>
                          </button>
                        </div>
                      </div>
                      <div class="form-group"> <label class="col-md-3 col-lg-2 pr-0 control-label">題目清單</label>
                        <div class="col-md-9 col-lg-9 col-xl-8">
                          <div class="table-responsive">
                            <table class="table table-style-default CAvideo-table">
                              <thead>
                                <tr>
                                  <th class="time">影片時間點</th>
                                  <th class="type">題型</th>
                                  <th class="title">題目</th>
                                  <th class="tools"></th>
                                </tr>
                              </thead>
                              <tbody>
                                <!--<tr>
                                  <td class="time">01:06</td>
                                  <td class="type">選擇題</td>
                                  <td class="title">小熊說了什麼？</td>
                                  <td class="tools"><button class="CAvideo-tableBtn"><i class="fas fa-pen"></i></button>
                                    <button class="CAvideo-tableBtn"><i class="fas fa-trash"></i></button></td>
                                </tr>
                                <tr>
                                  <td class="time">02:00</td>
                                  <td class="type">問答題</td>
                                  <td class="title">小熊說了什麼？?</td>
                                  <td class="tools"><button class="CAvideo-tableBtn"><i class="fas fa-pen"></i></button>
                                    <button class="CAvideo-tableBtn"><i class="fas fa-trash"></i></button></td>
                                </tr>-->
                              </tbody>
                            </table>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <!-- 按鈕 -->
          <div class="row classActivity__tools" style="">
            <div class="col-xs-12 col-sm-6 text-left"> <a class="btn btn-main-cyan-white btn-lg" role="button" href="editUnit__activity.html" id="BACK">返回課堂活動</a> </div>
            <div class="col-xs-12 col-sm-6 text-right"> <a class="btn btn-main-cyan btn-lg" role="button" target="_blank" href="../STUDENT/CLASS_ACTIVITY/video.html?user=t" id="PREVIEW">預覽看影片回答問題</a> <a class="btn btn-main-cyan btn-lg" role="button" href="editUnit__activity.html" id="SAVE">儲存</a> </div>
          </div>
          <!-- --> 
        </div>
      </div>
      <!-- 右邊內容end --> 
    </div>
  </div>
</main>
<!-- Modal#topicModal -->
<div class="modal fade" id="topicModal" tabindex="-1" role="dialog" aria-labelledby="topicModalLabel" data-backdrop="static" data-keyboard="false">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header noBorder">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
      </div>
      <div class="modal-body">
        <div class="form-horizontal form-style-2">
          <div class="form-group"> <label class="col-md-3  pr-0 control-label"><span class="text-red">*</span>時間點</label>
            <div class="col-md-8">
              <input type="text" class="form-control" id="inputSec" disabled="disabled">
            </div>
          </div>
          <div class="form-group"> <label class="col-md-3  pr-0 control-label"><span class="text-red">*</span>題型</label>
            <div class="col-md-8">
              <select class="form-control" id="selectQtype">
                <option value="choice">選擇題</option>
                <option value="quiz">問答題</option>
              </select>
            </div>
          </div>
          <!-- 選擇題欄位 start -->
          <div class="collapse in" id="choice">
            <div class="form-group"> <label class="col-md-3 pr-0 control-label"><span class="text-red">*</span>題目</label>
              <div class="col-md-8">
                <textarea class="form-control" rows="5" id="choiceQtype" placeholder="請在此輸入題目..."></textarea>
              </div>
            </div>
            <div class="form-group"> <label class="col-md-3 pr-0 control-label"><span class="text-red">*</span>選項</label>
              <div class="col-md-8">
                <ul class="list-group mt-n2 CAvideo-answerSort">
                  <li class="list-group-item noBorder px-0">
                    <div class="align-items-center">
                      <div class="input-group"> <span class="input-group-addon">A.</span>
                        <input type="text" class="form-control" placeholder="請輸入選項...">
                        <span class="input-group-btn">
                        <button class="btn btn-default" type="button">×</button>
                        </span> </div>
                    </div>
                  </li>
                  <li class="list-group-item noBorder px-0">
                    <div class="align-items-center">
                      <div class="input-group"> <span class="input-group-addon">B.</span>
                        <input type="text" class="form-control" placeholder="請輸入選項...">
                        <span class="input-group-btn">
                        <button class="btn btn-default" type="button">×</button>
                        </span> </div>
                    </div>
                  </li>
                  <li class="list-group-item noBorder px-0">
                    <div class="align-items-center">
                      <div class="input-group"> <span class="input-group-addon">C.</span>
                        <input type="text" class="form-control" placeholder="請輸入選項...">
                        <span class="input-group-btn">
                        <button class="btn btn-default" type="button">×</button>
                        </span> </div>
                    </div>
                  </li>
                </ul>
                <div class="mt-n2">
                  <button class="btn btn-default text-gray btn-block btn-addOption"><i class="fas fa-plus"></i>&nbsp;增加選項</button>
                </div>
              </div>
            </div>
            <div class="form-group"> <label class="col-md-3 pr-0 control-label"><span class="text-red">*</span>作答時間</label>
              <div class="col-md-8">
                <input type="text" class="form-control" style="display: inline-block; width: 50px;" id="choice-ansTimeMin">
                &nbsp;分&nbsp;&nbsp;
                <input type="text" class="form-control" style="display: inline-block; width: 50px;" id="choice-ansTimeSec">
                &nbsp;秒</div>
            </div>
          </div>
          <!-- 選擇題欄位  end  --> 
          <!-- 問答題欄位 start -->
          <div class="collapse" id="quiz">
            <div class="form-group"> <label class="col-md-3 pr-0 control-label"><span class="text-red">*</span>題目</label>
              <div class="col-md-8">
                <textarea class="form-control" rows="5" id="" placeholder="請在此輸入題目..." ></textarea>
              </div>
            </div>
            <div class="form-group"> <label class="col-md-3 pr-0 control-label"><span class="text-red">*</span>作答時間</label>
              <div class="col-md-8">
                <input type="text" class="form-control" style="display: inline-block; width: 50px;" id="quiz-ansTimeMin">
                &nbsp;分&nbsp;&nbsp;
                <input type="text" class="form-control" style="display: inline-block; width: 50px;" id="quiz-ansTimeSec">
                &nbsp;秒</div>
            </div>  
          </div>
          <!-- 問答題欄位  end  --> 
        </div>
        <div class="text-center py-3">
          <button type="button" class="btn btn-main-cyan-white" data-dismiss="modal">取消</button>
          <button type="button" class="btn btn-main-cyan" id="INSERT_OK">確定</button>
          <button type="button" class="btn btn-main-cyan" id="EDIT_OK">修改題目</button>
        </div>
      </div>
    </div>
  </div>
</div>
<!-- ------- ------- ------- ------- ------- ------- ------- --> 
<!-- ------- ------- ------- ------- ------- ------- ------- --> 
<!-- ------- ------- ------- ------- ------- ------- ------- --> 
<script src="../Script/jquery.min.js"></script> 
<script src="../Script/bootstrap.min.js"></script> 
<script src="../Script/ie10-viewport-bug-workaround.js"></script> 
<!-- widgets js --> 
<script src="../Content/js/defaultText.js">//預設圖片+單元名</script> 
<script src="../Content/js/modalBlack.js">//處理中黑頻modal</script> 
<script src="../Content/widgets/jquery-ui-1.12.1.custom/jquery-ui.min.js"></script> 
<script src="../Content/widgets/jquery-ui-1.12.1.custom/jquery.ui.touch-punch.min.js"></script> 
<script src="https://www.youtube.com/iframe_api"></script> 
<script src="../Content/js/getSearch.js">//取得URL search</script> 
<script>
$(document).ready(function() {
    //nowPage 
	$('.navTab-myLibs').addClass('active');
    
    //僅demo模擬，正式請刪除。/////////////////////////////////////////////////
    var oriSearch = GetQueryString('activity');

    //[返回] 連結帶?activity
    $('#BACK').click(function(e){
        e.preventDefault();
        window.location.href = $(this).attr('href') + '?activity=' + oriSearch;
    });   

    //[預覽] 
    $('#PREVIEW').click(function(e){
        e.preventDefault();

        //do something... (判斷*是否有填)
        let Validation = true;
        if( Validation != true ){
            alert('*不可空白。');
        }else{
            window.open( $(this).attr('href') , '_blank');   
        } 
    }); 

    //[儲存] 
    $('#SAVE').click(function(e){
        e.preventDefault();

        //do something... (驗證欄位是否有填及正確)

        alert('成功儲存看影片回答問題。\n可至單元-課堂活動開啟活動。'); 

        var activityID = '7';
        window.location = $(this).attr('href') + '?activity=' + oriSearch + 'a'+ activityID;
    });
    

    let videoId;
    let clipStart, clipEnd;
    let topicPoints = [];
    
    const progress = $('.em-player__progress .progress'),
          clip     = $('.CAvideo-clip .clip-slider');
          
    let player;
    let playerInitialized = false; 
    let interval = null;  
    
    // [0|1] [無題|有題]
    let num = 0;

    if( num === 1 ){
        //do something... (若有題，則需載入資料)	
        videoId = '2tlmHypKQ44';
        clipStart = 10, 
        clipEnd = 30;
        topicPoints = [30, 50.025478];
    }
    
    
    //影片網址 > [預覽]
    $('#btnPreview').click(function(){
        //取得YT影片id
        let videoHref = $('#inputVideo').val(); 
        let url = new URL(videoHref, window.location.href);
        videoId = url.searchParams.get('v'); 

        if (videoId) {
            //重置播放器
            if (playerInitialized) {
                clearInterval(interval); 
                player.stopVideo();
                player.destroy(); 
                playerInitialized = false;  
            }

            $('.CAvideo-clip, .CAvideo-player').hide();

            //清空yt預設圖
            $('#ytDefault').attr('src', '').hide();

            //影片處理中
            showModalBlack('sm', `<div class="mb-3">影片處理中</div>
                            <div class="progress">
                            <div class="progress-bar progress-bar-cyan progress-bar-striped active" role="progressbar" aria-valuenow="" aria-valuemin="0" aria-valuemax="100" style=""></div>
                          </div>`); 

            //demo 影片處理中loading
            let num = 0, 
                time = 100; //預計花費時間
            let loading = setInterval(function() {
                num++;

                $('#modal-black .progress-bar').attr('aria-valuenow', num);
                $('#modal-black .progress-bar').css('width', num+'%');
                $('#modal-black .progress-bar').text(num+'%');

                if (num == 100) {
                    clearInterval(loading);

                    let timeout = setTimeout(function() {
                        $('#modal-black').modal('hide');

                        //call YouTubePlayerAPI
                        onYouTubeIframeAPIReady(videoId, clipStart, clipEnd);
                        
                        //顯示新增題目按鈕
                        $('#INSERT').prop('disabled', false); 
                    }, 1000);  
                }
            }, time/100);
        }else{
            alert('請確認並輸入正確的youtube網址。');    
        }
    });
    
    //[播放]
    $('.em-play').click(function () { 
        if (playerInitialized) {
            player.playVideo();
        }
    });
    //[暫停]
    $('.em-pause').click(function () {
        if (playerInitialized) {
            player.pauseVideo();
        }
    }); 
    //[重播]
    $('.em-replay').click(function () {
        if (playerInitialized) {
            if( $('.CAvideo-clip').is(":visible") ){
                player.seekTo(0);   
            }else{
                player.seekTo(clipStart);   
            }

            player.playVideo();
        }
    }); 
    
    //[剪片]
    $('#CLIP').click(function(){  console.log('準備剪片---');
        //[剪片]按鈕隱藏、顯示剪片區
        $('#CLIP').hide();
        $('.CAvideo-clip').show();
                 console.log(clipStart + ' ~ ' + clipEnd);
        clipSlider(player, clipStart, clipEnd);                        

        //重置progress Slide
        progress.slider('destroy');
                                
        //重置播放器
        if (playerInitialized) {
            clearInterval(interval);  
            player.stopVideo();
            player.destroy(); 
            playerInitialized = false;  
        } 
        //call YouTubeIframeAPI                        
        onYouTubeIframeAPIReady(videoId, 0, (player.getDuration()-1));   
        
        //[新增題目]不可按
        $('#INSERT').prop('disabled', true);
    });
    //[剪片]>[取消]
    $('#CLIP_CANCEL').click(function(){console.log('取消剪片---');console.log(clipStart + ' ~ ' + clipEnd);
        $('#CLIP').show();
        $('.CAvideo-clip').hide();

        $('#INSERT').prop('disabled', false);
        
        //還原
        if (playerInitialized) { 
            clearInterval(interval);                     
            player.stopVideo();
            player.destroy(); 
            playerInitialized = false; 
        }
        progress.slider('destroy');
        onYouTubeIframeAPIReady(videoId, clipStart, clipEnd);                               
    });
    //[剪片]>[剪片]
    $('#CLIP_OK').click(function(){  
        //取得幫前剪片片段
        clipStart = clip.slider('values', 0),
        clipEnd   = clip.slider('values', 1); 
        console.log(clipStart + ' ~ ' + clipEnd);                           
                                   
       console.log(topicPoints);
        
        let outOfRange = false; //[true | false] [超出範圍 | 範圍之內] 
        let outOfRangePoints = []; 
                                   
        $.each(topicPoints, function(index, value) {
            if (value < clipStart || value > clipEnd) {
                outOfRange = true;
                outOfRangePoints.push( formatTime(value) );
            }
        }); 
                                   
        if (outOfRange) {  //若有題目超出剪輯片段，則跳出提示
            if( confirm(outOfRangePoints.join(", ") +' 有題目，您確定要剪掉嗎？') ){
                clipOk(clipStart, clipEnd);   
                
            }
        } else{
            clipOk(clipStart, clipEnd);   
        }
        
        function clipOk(clipStart, clipEnd){  
            if (playerInitialized) { 
                clearInterval(interval);                     
                player.stopVideo();
                player.destroy(); 
                playerInitialized = false; 
            }
            progress.slider('destroy');
            onYouTubeIframeAPIReady(videoId, clipStart, clipEnd);
                          
            $('.em-play').show().siblings('.btn').hide();

            $('#INSERT').prop('disabled', false); 
            
            $('#CLIP').show();
            $('.CAvideo-clip').hide();
        }
    });
    
    //[新增題目]
    $('#INSERT').click(function(){
        player.pauseVideo();

        //do something...判斷是否重複新增題目？

        //無重複則可新增題目...
        $('#topicModal').modal('show');
        $('#INSERT_OK').show();
        $('#EDIT_OK').hide(); 
    });
    //[新增題目] > 題型 切換
    $('#selectQtype').change(function(){
        let selecVal = $(this).val();

        $('#'+ selecVal).collapse('show')
                        .siblings('.collapse').collapse('hide');
        
        //do something...清除已填欄位?
    });
    //[新增題目] > [增加選項]
    $('.btn-addOption').click(function(){
        let target = $(this).parent().prev('ul'),
            targetLenght = target.find('li').length;

        let addNum = (targetLenght+1),
            addString = String.fromCharCode(addNum + 64);

        target.append(`<li class="list-group-item noBorder px-0">
                          <div class="align-items-center">
                            <div class="input-group"> <span class="input-group-addon">`+ addString +`.</span>
                              <input type="text" class="form-control" placeholder="請輸入選項...">
                              <span class="input-group-btn">
                              <button class="btn btn-default" type="button">×</button>
                              </span></div>
                            </div>
                        </li>`);
    });
    //拖曳更換答案設定順序  
    sortOption();
    
    //[新增題目] > [新增題目]
    $('#INSERT_OK').click(function(){ 
        //do something...判斷欄位是否有填

        //demo 成功新增新增題目
        $('#topicModal').modal('hide');

        $('.CAvideo-table tbody')
            .prepend(`<tr>
                        <td class="time">`+ $('#inputSec').val() +`</td>
                        <td class="type">選擇題</td>
                        <td class="title">小熊說了什麼？</td>
                        <td class="tools"><button class="CAvideo-tableBtn EDIT"><i class="fas fa-pen"></i></button>
                          <button class="CAvideo-tableBtn DELETE"><i class="fas fa-trash"></i></button></td>
                      </tr>`);

        //新增題目時間點
        AddTopicTime(progress, player.getCurrentTime());
        topicPoints.push(player.getCurrentTime());  console.log(topicPoints);
        //將播放軸點放置到影片起始處(方便清楚查看新增題目點)
        player.seekTo(progress.slider('option', 'min'));                             
    });  

    //(fa-pen)修改題目
    $('.CAvideo-table tbody').on('click', '.EDIT', function() {
        $('#topicModal').modal('show');
        $('#INSERT_OK').hide();
        $('#EDIT_OK').show(); 

        //do something...取得題目資訊...
    });
    //(fa-pen)修改題目 > [修改題目]
    $('#EDIT_OK').click(function(e){
        $('#topicModal').modal('hide');
    });   

    //(fa-trash)刪除題目
    $('.CAvideo-table tbody').on('click', '.DELETE', function() {
        //demo刪除題目
        let thisTr = $(this).parents('tr');
        let thisTime = thisTr.find('.time').text();
        if(confirm('是否刪除影片時間點 '+ thisTime +' 的題目')){
            thisTr.remove();       
        }
    });

    $('#topicModal').on('shown.bs.modal', function (e) {
        //取得題目影片時間點
        let currentTime = player.getCurrentTime();
        $('#inputSec').val( formatTime(currentTime) );

        //do something...
    });
    $('#topicModal').on('hidden.bs.modal', function (e) {
        //do something...清空欄位
    }); 
    
   

    //YouTubeIframeAPI
    function onYouTubeIframeAPIReady(videoId, playStart, playEnd) { 
        if(videoId){
            player = new YT.Player('ytplayer', {
                height: '360',      //預設，但bootstrap會自動縮放
                width: '640',       //預設，但bootstrap會自動縮放
                videoId: videoId,
                playerVars: {
                    'autoplay': 0,
                    'controls': 0,
                    'enablejsapi': 1,
                    'start': playStart,
                    'end': playEnd
                },
                events: {
                    'onReady': function(event) {
                        event.target.setPlaybackQuality('large');

                        if (!playStart) {
                            playStart = 0; 
                        } 
                        if (!playEnd) {
                            playEnd = player.getDuration() - 1; // 若playEnd為空，則為影片的總時長 (誤差一秒)
                        } 
                        onPlayerReady(event, playStart, playEnd);
                    },
                    'onStateChange': function(event) {
                        onPlayerStateChange(event, playStart, playEnd);
                    }
                }
            });  
        }
    }

    function onPlayerReady(event, playStart, playEnd) {  
        playerInitialized = true;

        var videoData = player.getVideoData();   

        if( videoData.isPlayable ){ //成功嵌入影片
            //顯示YT影片縮圖，以隱藏YT play icon
            $('#ytDefault').attr('src', 'https://img.youtube.com/vi/' + videoData.video_id + '/hqdefault.jpg').show();

            //顯示控制區域
            $('.CAvideo-player').show();  

            //進度條slider 
            progressSlider(player, playStart, playEnd); 
            
            //增加題目時間點
            console.log('1');
            console.log(topicPoints);
            $('.ui-slider-topic').remove();
            for(let i=0; i<topicPoints.length; i++){
                AddTopicTime(progress, topicPoints[i]);  
                console.log(topicPoints[i]);
            }
        }else{//無法嵌入影片
            alert('該影片因權限問題無法成功嵌入，請更換影片。');

            //清空影片網址欄及yt預設圖片
            $('#inputVideo').val('');
            $('#ytDefault').attr('src', '').hide();

            //重製播放器
            if (playerInitialized) {
                player.stopVideo();
                player.destroy(); 
                playerInitialized = false;  
            }    
        }                                   
    }

    function onPlayerStateChange(event, playStart, playEnd) {  
        if (event.data === YT.PlayerState.PLAYING) { 
            clearInterval(interval);
            //目前播放秒數
            interval = setInterval(function() {
                updatePlayerInfo(playStart, playEnd);
            }, 1000);

            //更換按鈕、隱藏YT影片縮圖
            $('.em-pause').show().siblings('.btn').hide();
            $('#ytDefault').hide();
        } else if (event.data === YT.PlayerState.PAUSED) {
            //更換按鈕、隱藏YT影片縮圖
            $('.em-play').show().siblings('.btn').hide();
            $('#ytDefault').hide();
        } else if (event.data === YT.PlayerState.ENDED) { 
            //更換按鈕、顯示YT影片縮圖
            $('.em-replay').show().siblings('.btn').hide();
            $('#ytDefault').show();
        }
    } 

    function updatePlayerInfo(playStart, playEnd) { 
        if (playerInitialized) {
            var currentTime = player.getCurrentTime();      //目前yt時間
            var duration = playEnd - playStart;             //目前播放總時長 
            var playTime = currentTime - playStart;         //目前播放時間
            var percentage = (playTime / duration) * 100;

            //目前播放時間
            $('.em-player__Nowsec').text( formatTime(currentTime - playStart) );

            //進度條
            progress.slider('value', currentTime);   

            //[新增題目]時間顯示
            $('#INSERT label').text( formatTime(playTime) );
        }
    } 

    //進度條slider    
    function progressSlider(player, playStart, playEnd, playVideo = false){ 
        progress.slider({
            range: 'min',
            min: playStart,
            max: playEnd,
            create: function (event, ui) {
                $('.em-player__Nowsec').text( '00:00' );

                $('.em-player__totalSec').text( formatTime(playEnd - playStart) );
            },
            slide: function( event, ui ) { 
                //滑動時更新當前秒數
                $('.em-player__Nowsec').text( formatTime(player.getCurrentTime()) );

                //滑動時更新時間軸、播放該時間影片
                $(this).slider('value', ui.value);                          
                player.seekTo(ui.value);
            }
        });
    }   

    //剪片slider    
    function clipSlider(player, clipStart=0, clipEnd=player.getDuration() - 1){ 
        console.log('開啟剪片軸---');
        console.log(clipStart + ' ~ ' + clipEnd);
       clip.slider({
            range: true,
            min: 0,
            max: player.getDuration() - 1,
            values: [clipStart, clipEnd],
            create: function( event, ui ) {
                //添加顯示已剪片範圍秒數tooltip
                $(this).find('.ui-slider-handle').eq(0).append('<span class="slider-tooltip">' + formatTime( clipStart ) + '</span>');
                $(this).find('.ui-slider-handle').eq(1).append('<span class="slider-tooltip">' + formatTime( clipEnd ) + '</span>'); 
            },
            slide: function( event, ui ) {
                //滑動時更新秒數tooltip
                $(this).find('.ui-slider-handle').eq(ui.handleIndex)
                       .find('.slider-tooltip').text( formatTime(ui.values[ui.handleIndex]) );

                //滑動時更新progress時間軸並播放該時間影片
                progress.slider('value', ui.values[ui.handleIndex]);
                progress.slider('option', 'slide')
                    .call(progress, event, { value: ui.values[ui.handleIndex] });
            }
        });
    } 
    
    //新增題目時間點
    function AddTopicTime(progress, sec){ 
        //若秒數在播放時間片段內，則增加節點  
        let progressMin = progress.slider('option', 'min'),
            progressMax = progress.slider('option', 'max'); 

        if( sec >= progressMin && sec <= progressMax ){
            let percentage = ((sec - progressMin) / (progressMax - progressMin)) * 100; 
            progress.append('<span class="ui-slider-topic" style="left: ' + percentage + '%;"></span>');
        }  
    }  

    //格式化時間 MM:SS
    function formatTime(seconds) {
        var date = new Date(null);
        date.setSeconds(seconds);
        return date.toISOString().substr(14, 5);
    }
    
    //拖曳更換答案設定順序   
    function sortOption(){
        $('.CAvideo-answerSort').sortable({
            items: '> li',
            placeholder: 'ui-sortable-placeholder',
            start: function(e, ui) {
                //佔位符號寬度=拖曳物件
                ui.placeholder.width(ui.item.width());
                ui.placeholder.height(ui.item.height());
            },
            update: function(event, ui) {
                var $listGroup = $(this);

                $listGroup.find('li').each(function(index) {
                    $(this).find('input[type="radio"]').val(String.fromCharCode(65 + index));
                    $(this).find('.input-group-addon').text(String.fromCharCode(65 + index) + '.');
                });
            },
        });
    } 
    });
</script> 
<script> 
     
</script>
</body>
</html>
